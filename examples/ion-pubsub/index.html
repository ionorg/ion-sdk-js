<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous" />
  <style>
    #remotes video {
      width: 320px;
    }
  </style>
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/uuid@latest/dist/umd/uuidv4.min.js"></script>
  <title>Pion ion-cluster | Pub Sub test</title>
</head>

<body>
  <nav class="navbar navbar-light bg-light border-bottom">
    <h3>Pion</h3>
  </nav>
  <div class="container pt-4">
    <div class="row" id="start-btns">
      <div class="col-12">
        <button type="button" class="btn btn-primary" onclick="start(false)">
          start
        </button>
      </div>
    </div>
    <div class="row" >
      <div class="col-12">
        <select id="select-box1">
          <option value="vp8" selected="selected" >vp8</option>
          <option value="h264">h264</option>
        </select>
        <select id="select-box2">
          <option value="qvga">qvga_320_180</option>
          <option value="vga" selected="selected" >vga_640_360</option>
          <option value="shd">shd_960_540</option>
          <option value="hd">hd_1280_720</option>
          <option value="fhd">qvga_1980_1080</option>
          <option value="fhd">qvga_2560_1440</option>
        </select>
        <input type="checkbox" id = "check-box">Simulcast
          <select id="select-box3" style="position: absolute ;margin-right: 5px;">
          <option value="q" selected="selected" onchange="subscribe()" >Simulcast_q</option>
          <option value="h" onchange="subscribe()" >Simulcast_h</option>
          <option value="f" onchange="subscribe()" >Simulcast_f</option>
          </select>
      </div>
    </div>

    <div class="row">
      <div class="col-6 pt-2">
        <span style="position: absolute; margin-left: 5px; margin-top: 5px" class="badge badge-primary">Local</span>
        <video id="local-video" style="background-color: black" width="320" height="240"></video>
        <div class="controls" style="display: none">
          <div class="row pt-3">
            <div class="col-3">
              <strong>Video</strong>
              <div class="radio">
                <label><input type="radio" onclick="controlLocalVideo(this)" value="true" name="optlocalvideo"
                    checked />
                  Unmute</label>
              </div>
              <div class="radio">
                <label><input type="radio" onclick="controlLocalVideo(this)" value="false" name="optlocalvideo" />
                  Mute</label>
              </div>
            </div>
            <div class="col-3">
              <strong>Audio</strong>
              <div class="radio">
                <label><input type="radio" onclick="controlLocalAudio(this)" value="true" name="optlocalaudio"
                    checked />
                  Unmute</label>
              </div>
              <div class="radio">
                <label><input type="radio" onclick="controlLocalAudio(this)" value="false" name="optlocalaudio" />
                  Mute</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="remotes" class="col-6 pt-2">
        <span style="position: absolute; margin-left: 5px; margin-top: 5px" class="badge badge-primary">Remotes</span>

      </div>
    </div>

      <div class="row">
        <div class="col-12 pt-4">Event</div>
      </div>
      <div class="row">
        <div class="col-6 pt-2">
          <pre
            id="remote-signal"
            class="d-block border"
            style="
              background-color: #f8f9fa;
              height: 117px;
              width: 800px;
              margin: 5px 0;
              word-break;
              break-all;
              word-wrap:break-word;
            "
          ></pre>
        </div>
      </div>
      <div class="row">
        <div class="col-12 pt-4">DataChannel</div>
      </div>
      <div class="row">
        <div class="col-6 pt-2">
          <textarea
            id="local-data"
            class="d-block border"
            style="
              background-color: #f8f9fa;
              height: 117px;
              width: 320px;
              margin: 5px 0;
              padding: 5px;
            "
            placeholder="Send a message"
          ></textarea>
          <button type="button" class="btn btn-primary" onclick="send()">
            send
          </button>
        </div>
        <div class="col-6 pt-2">
          <pre
            id="remote-data"
            class="d-block border"
            style="
              background-color: #f8f9fa;
              height: 117px;
              width: 320px;
              margin: 5px 0;
            "
          ></pre>
        </div>
      </div>

  </div>
  <!-- Optional JavaScript -->
  <script src="build/bundle.js"></script>
  <script>
    const localVideo = document.getElementById("local-video");
    const remotesDiv = document.getElementById("remotes");

    /* eslint-env browser */
    const joinBtns = document.getElementById("start-btns");
    const connector = new Ion.Connector("http://localhost:5551");
    const codecBox = document.getElementById("select-box1");
    const resolutionBox = document.getElementById("select-box2");
    const simulcastBox = document.getElementById("check-box");
    const localData = document.getElementById("local-data");
    const remoteData = document.getElementById("remote-data");
    const remoteSignal= document.getElementById("remote-signal");
    const subscribeBox = document.getElementById("select-box3");
    let localDataChannel;
    let event;
    connector.onopen = function (svc) {
      console.log("onopen: service = ", svc.name);
    };

    connector.onclose = function (svc, err) {
      console.log("onclose: service = ", svc.name, ", err = ", JSON.stringify(err.detail));
    };

    const uid = uuidv4();
    const sid = "ion";
    const sfu = new Ion.RTC(connector);

    sfu.ontrackevent = function (ev) {
      console.log("ontrackevent: \nuid = ", ev.uid, " \nstate = ", ev.state, ", \ntracks = ", JSON.stringify(ev.tracks));
      event = ev;
      /*
      var infos = [];
      ev.tracks.forEach(t => {
          infos.push({
            track_id: t.id,
            mute: t.muted,
            layer: t.layer,
            subscribe: true
          });
      });
      sfu.subscribe(infos);
      */
      remoteSignal.innerHTML = remoteSignal.innerHTML + JSON.stringify(ev) + '\n';
    };

    sfu.ondatachannel = ({ channel }) => {
      console.log("sfu.ondatachannel channel=", channel)
      channel.onmessage = ({ data }) => {
        remoteData.innerHTML = remoteData.innerHTML + data + '\n';
      };
    };

    <!-- sfu.connect(); -->

    sfu.join(sid, uid);

    const streams = {};
    let localStream;
    const start = () => {
      let constraints = {
        resolution: resolutionBox.options[resolutionBox.selectedIndex].value,
        codec: codecBox.options[codecBox.selectedIndex].value,
        audio: true,
        simulcast: simulcastBox.checked,
      }
      console.log("getUserMedia constraints=", constraints)
      Ion.LocalStream.getUserMedia(constraints)
        .then((media) => {
          localStream = media;
          localVideo.srcObject = media;
          localVideo.autoplay = true;
          localVideo.controls = true;
          localVideo.muted = true;
          joinBtns.style.display = "none";
          sfu.publish(media);
          localDataChannel = sfu.createDataChannel(uid);
        })
        .catch(console.error);
    };

    const send = () => {
        if (!localDataChannel) {
            alert('click "start" first!', '', {
            confirmButtonText: 'OK',
          });
          return
        }
      if (localDataChannel.readyState === "open") {
        localDataChannel.send(localData.value);
      }
    };

    const subscribe = () => {
        let layer = subscribe.value
        console.log("subscribe event=", event, "layer=", layer)
        var infos = [];
        event.tracks.forEach(t => {
            if (t.layer === layer){
              infos.push({
                track_id: t.id,
                mute: t.muted,
                layer: t.layer,
                subscribe: true
              });
            }
        });
        console.log("subscribe infos=", infos)
        sfu.subscribe(infos);
    }

    sfu.ontrack = (track, stream) => {
      console.log("got ", track.kind, " track", track.id, "for stream", stream.id);
      if (track.kind === "video") {
        track.onunmute = () => {
          if (!streams[stream.id]) {
            const remoteVideo = document.createElement("video");
            remoteVideo.srcObject = stream;
            remoteVideo.autoplay = true;
            remoteVideo.muted = true;
            remotesDiv.appendChild(remoteVideo);
            streams[stream.id] = stream;
            stream.onremovetrack = () => {
              if (streams[stream.id]) {
                remotesDiv.removeChild(remoteVideo);
                streams[stream.id] = null;
              }
            };
          }
        };
      }
    };

    const controlLocalVideo = (radio) => {
      if (radio.value === "false") {
        localStream.mute("video");
      } else {
        localStream.unmute("video");
      }
    };

    const controlLocalAudio = (radio) => {
      if (radio.value === "false") {
        localStream.mute("audio");
      } else {
        localStream.unmute("audio");
      }
    };

  </script>
</body>

</html>
